module(load="imudp")
module(load="imtcp")
module(load="imrelp")

template(name="puppet-master" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/puppet-master.log")
template(name="unknownFile" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/unknown.log")
template(name="mcollective" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/mcollective.log")
template(name="sulog" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/sulog.log")
template(name="mcollective_audit" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/mcollective_audit.log")
template(name="dpkg" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/dpkg.log")
template(name="puppetDB" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/puppetdb.log")
template(name="Auth" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/auth.log")
template(name="Kern" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/kern.log")
template(name="User" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/user.log")
template(name="Daemon" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/daemon.log")
template(name="Audit" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/audit.log")
template(name="SASL" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/sasl.log")
template(name="Postfix" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/postfix.log")
template(name="SLAPD" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/slapd.log")
template(name="SSHD" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/sshd.log")
template(name="Puppet" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/puppet.log")
template(name="Mail" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/mail.log")
template(name="Sys" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/syslog.log")
template(name="Other" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/other.log")
template(name="Cron" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/cron.log")
#template(name="authpriv" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/secure")
#template(name="dnf" type="string" string="/rsyslog/%$YEAR%/%$MONTH%/%$DAY%/%FROMHOST%/dnf.log")
template(name="auditFormat" type="string" string="%msg%\n")



ruleset(name="remote" queue.type="LinkedList" queue.size="80000" queue.dequeuebatchsize="1000" queue.fulldelaymark="70000" queue.discardmark="79000" queue.discardseverity="4" queue.timeoutenqueue="0" queue.workerthreads="25") {

if $syslogtag == 'file_log_audit' then {
  action(type="omfile" template="auditFormat" dynaFile="Audit" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="40000")
  stop
}

if $syslogtag == 'file_log_mcollective' then {
  action(type="omfile" dynaFile="mcollective_audit" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="40000")
  stop
}

if $syslogtag == 'file_log_mcollective' then {
  action(type="omfile" dynaFile="mcollective" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="40000")
  stop
}

if $syslogtag == 'file_log_dpkg' then {
  action(type="omfile" dynaFile="dpkg" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="40000")
  stop
}

if $syslogtag == 'file_log_sulog' then {
  action(type="omfile" dynaFile="sulog" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="40000")
  stop
}

if $programname == 'slapd' then {
  action(type="omfile" dynaFile="SLAPD" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k")
  stop
}

if $programname startswith 'sshd' then {
  action(type="omfile" dynaFile="SSHD" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList")
  stop
}

if $syslogtag == 'file_log_puppetdb' then {
  action(type="omfile" dynaFile="puppetDB" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="40000")
  stop
}

if $programname == 'puppet-master' then {
  action(type="omfile" dynaFile="puppet-master" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList")
  stop
}

if $programname == 'puppet-agent' then {
  action(type="omfile" dynaFile="Puppet" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList")
  stop
}

if $syslogfacility-text == 'mail' then {
  action(type="omfile" dynaFile="Mail" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="60000")
  stop
}

if $programname startswith 'postfix' then {
  action(type="omfile" dynaFile="Postfix" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.workerthreads="5" queue.size="50000")
  stop
}

if $programname == 'saslauthd' then {
  action(type="omfile" dynaFile="SASL" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.workerthreads="2" queue.size="50000")
  stop
}

if ($syslogfacility-text == 'auth' or $syslogfacility-text == 'authpriv') then {
  action(type="omfile" dynaFile="Auth" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="50000")
  stop
}

if $syslogfacility-text == 'kern' then {
  action(type="omfile" dynaFile="Kern" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="50000")
  stop
}

if $syslogfacility-text == 'user' then {
  action(type="omfile" dynaFile="User" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList")
  stop
}

if $syslogfacility-text == 'daemon' then {
  action(type="omfile" dynaFile="Daemon" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="20000")
  stop
}

if $syslogfacility-text == 'cron' then {
  action(type="omfile" dynaFile="Cron" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList")
  stop
}

if $syslogfacility-text == 'syslog' or ($syslogfacility-text == 'authpriv' and $syslogseverity-text == 'none') then {
  action(type="omfile" dynaFile="Sys" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="50000")
  stop
}

# This is a catch-all for files
if $syslogtag startswith 'file_log_' then {
  action(type="omfile" dynaFile="unknownFile" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="40000")
  stop
}


# NO RULES BELOW THIS LINE AND ONLY STOP RULES ABOVE IT!!!
action(type="omfile" dynaFile="Other" asyncWriting="on" flushOnTXEnd="off" ioBufferSize="128k" queue.type="LinkedList" queue.size="50000")
stop

}

input(type="imudp" port="10514" ruleset="remote")
input(type="imtcp" port="10514" ruleset="remote")
input(type="imrelp" port="12514" ruleset="remote")
